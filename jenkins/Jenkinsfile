pipeline {
    agent any
    
    environment {
        // Build servers
        BUILD_FRONT_HOST = '192.168.1.205'
        BUILD_BACK_HOST = '192.168.1.206'
        
        // Production servers
        PROD_BACKEND_HOSTS = '192.168.1.201,192.168.1.202,192.168.1.203'
        PROD_NGINX_HOST = '192.168.1.200'
        
        // Git configuration
        GIT_BRANCH = 'main'
        FRONTEND_REPO = 'https://github.com/DevOps-ProjectLevel/provedcode-frontend-vitya199909.git'
        BACKEND_REPO = 'https://github.com/DevOps-ProjectLevel/provedcode-backend-vitya199909.git'
        
        // Frontend build configuration
        REACT_APP_BASE_URL = 'http://192.168.1.200/api'
        
        // Backend runtime configuration (non-sensitive)
        SPRING_PROFILES_ACTIVE = 'prod'
        DB_URL = '192.168.1.204:5432/mydb'
        S3_REGION = 'us-west-1'
        BUCKET = 'my-bucket'
        
        // Credentials
        SSH_PASS = credentials('ssh-password')
        DB_LOGIN = credentials('db-login')
        DB_PASSWORD = credentials('db-password')
        S3_ACCESS_KEY = credentials('s3-access-key')
        S3_SECRET_KEY = credentials('s3-secret-key')
    }
    
    stages {
        stage('Checkout Code') {
            parallel {
                stage('Checkout Frontend') {
                    steps {
                        dir('frontend') {
                            git branch: "${GIT_BRANCH}", url: "${FRONTEND_REPO}", credentialsId: 'jenkins-ssh-key'
                        }
                    }
                }
                stage('Checkout Backend') {
                    steps {
                        dir('backend') {
                            git branch: "${GIT_BRANCH}", url: "${BACKEND_REPO}", credentialsId: 'jenkins-ssh-key'
                        }
                    }
                }
            }
        }
        
        stage('Build') {
            parallel {
                stage('Build Frontend') {
                    steps {
                        script {
                            echo "Building Frontend on ${BUILD_FRONT_HOST}"
                            sh """
                                # Copy source code
                                sshpass -p '${SSH_PASS}' scp -r -o StrictHostKeyChecking=no frontend/ root@${BUILD_FRONT_HOST}:/tmp/frontend-build/
                                
                                # Build using Docker with environment variables
                                sshpass -p '${SSH_PASS}' ssh -o StrictHostKeyChecking=no root@${BUILD_FRONT_HOST} '
                                    cd /tmp/frontend-build &&
                                    docker run --rm \
                                      -v "\$(pwd)":/workspace \
                                      -w /workspace \
                                      -e REACT_APP_BASE_URL="${REACT_APP_BASE_URL}" \
                                      node:18-alpine sh -c "npm install && npm run build" &&
                                    tar -czf frontend-build.tar.gz dist/
                                '
                                
                                # Copy artifact back
                                sshpass -p '${SSH_PASS}' scp -o StrictHostKeyChecking=no root@${BUILD_FRONT_HOST}:/tmp/frontend-build/frontend-build.tar.gz ./
                            """
                            archiveArtifacts artifacts: 'frontend-build.tar.gz', fingerprint: true
                        }
                    }
                }
                
                stage('Build Backend') {
                    steps {
                        script {
                            echo "Building Backend on ${BUILD_BACK_HOST}"
                            sh """
                                # Copy source code
                                sshpass -p '${SSH_PASS}' scp -r -o StrictHostKeyChecking=no backend/ root@${BUILD_BACK_HOST}:/tmp/backend-build/
                                
                                # Build using Docker Maven wrapper
                                sshpass -p '${SSH_PASS}' ssh -o StrictHostKeyChecking=no root@${BUILD_BACK_HOST} '
                                    cd /tmp/backend-build &&
                                    docker run --rm -v "\$(pwd)":/workspace -v "\$HOME/.m2":/root/.m2 -w /workspace maven:3.9-eclipse-temurin-17-alpine mvn clean package &&
                                    tar -czf backend-build.tar.gz target/*.jar
                                '
                                
                                # Copy artifact back
                                sshpass -p '${SSH_PASS}' scp -o StrictHostKeyChecking=no root@${BUILD_BACK_HOST}:/tmp/backend-build/backend-build.tar.gz ./
                            """
                            archiveArtifacts artifacts: 'backend-build.tar.gz', fingerprint: true
                        }
                    }
                }
            }
        }
        
        stage('Deploy to Production') {
            steps {
                script {
                    // Deploy Frontend to nginx
                    sh """
                        sshpass -p '${SSH_PASS}' scp -o StrictHostKeyChecking=no frontend-build.tar.gz root@${PROD_NGINX_HOST}:/tmp/
                        sshpass -p '${SSH_PASS}' ssh -o StrictHostKeyChecking=no root@${PROD_NGINX_HOST} '
                            cd /var/www/html &&
                            rm -rf * &&
                            tar -xzf /tmp/frontend-build.tar.gz &&
                            nginx -s reload
                        '
                    """
                    
                    // Deploy Backend to all backend servers
                    env.PROD_BACKEND_HOSTS.split(',').each { host ->
                        sh """
                            # Copy jar file to backend server
                            sshpass -p '${SSH_PASS}' scp -o StrictHostKeyChecking=no backend-build.tar.gz root@${host}:/tmp/
                            
                            # Extract and deploy
                            sshpass -p '${SSH_PASS}' ssh -o StrictHostKeyChecking=no root@${host} '
                                cd /tmp && with environment variables
                                docker stop backend-app 2>/dev/null || true &&
                                docker rm backend-app 2>/dev/null || true &&
                                docker run -d \\
                                  --name backend-app \\
                                  --restart unless-stopped \\
                                  -p 8080:8080 \\
                                  -v /opt/backend/app.jar:/app/app.jar \\
                                  -e JAVA_OPTS=\"-Xmx512m -Xms256m\" \\
                                  -e SPRING_PROFILES_ACTIVE=\"${SPRING_PROFILES_ACTIVE}\" \\
                                  -e DB_LOGIN=\"${DB_LOGIN}\" \\
                                  -e DB_PASSWORD=\"${DB_PASSWORD}\" \\
                                  -e DB_URL=\"${DB_URL}\" \\
                                  -e S3_ACCESS_KEY=\"${S3_ACCESS_KEY}\" \\
                                  -e S3_SECRET_KEY=\"${S3_SECRET_KEY}\" \\
                                  -e S3_REGION=\"${S3_REGION}\" \\
                                  -e BUCKET=\"${BUCKET}\" \\
                                  -e EMAIL_USER=\"${EMAIL_USER}\" \\
                                  -e EMAIL_PASSWORD=\"${EMAIL_PASSWORD}
                                  --restart unless-stopped \\
                                  -p 8080:8080 \\
                                  -v /opt/backend/app.jar:/app/app.jar \\
                                  -e JAVA_OPTS=\"-Xmx512m -Xms256m\" \\
                                  eclipse-temurin:17-jdk-alpine \\
                                  java -jar /app/app.jar
                            '
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    // Check Frontend
                    echo "Checking frontend health..."
                    retry(3) {
                        sleep 5
                        sh """
                            curl -f -s -o /dev/null -w "%{http_code}" http://${PROD_NGINX_HOST} | grep -q 200
                        """
                    }
                    echo "‚úÖ Frontend is healthy!"
                    
                    // Check Backend servers
                    env.PROD_BACKEND_HOSTS.split(',').each { host ->
                        echo "Checking backend ${host} health..."
                        retry(5) {
                            sleep 10
                            sh """
                                curl -f -s -o /dev/null -w "%{http_code}" http://${host}:8080/actuator/health | grep -q 200 || \
                                curl -f -s -o /dev/null -w "%{http_code}" http://${host}:8080/health | grep -q 200 || \
                                curl -f -s -o /dev/null -w "%{http_code}" http://${host}:8080 | grep -q 200
                            """
                        }
                        echo "‚úÖ Backend ${host} is healthy!"
                    }
                    
                    echo "üöÄ All services are healthy and deployed successfully!"
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline completed successfully! üöÄ"
        }
        failure {
            echo "Pipeline failed! ‚ùå"
        }
        always {
            echo "Cleaning up workspace..."
            deleteDir()
        }
    }
}
