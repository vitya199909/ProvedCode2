- name: Install Jenkins via Docker on Alpine
  hosts: jenkins
  become: true

  tasks:
    - name: Fix APK repositories
      shell: |
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.22/main" > /etc/apk/repositories
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" >> /etc/apk/repositories

    - name: Update APK cache
      command: apk update

    - name: Install Docker
      apk:
        name: 
          - docker
          - sshpass
        state: present

    - name: Enable and start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Stop existing Jenkins container
      command: docker stop jenkins
      ignore_errors: yes

    - name: Remove existing Jenkins container
      command: docker rm jenkins
      ignore_errors: yes

    - name: Check if Jenkins is initialized
      stat:
        path: /opt/jenkins/config.xml
      register: jenkins_initialized

    - name: Remove old Jenkins data only if not initialized
      file:
        path: /opt/jenkins
        state: absent
      when: not jenkins_initialized.stat.exists

    - name: Create Jenkins directories
      file:
        path: "/opt/jenkins/{{ item }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'
      loop:
        - ""
        - init.groovy.d
        - workspace

    - name: Copy plugins list
      template:
        src: templates/plugins.txt
        dest: /opt/jenkins/plugins.txt
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Jenkins init script
      template:
        src: templates/basic-security.groovy.j2
        dest: /opt/jenkins/init.groovy.d/basic-security.groovy
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Create credentials init script
      template:
        src: templates/create-credentials.groovy.j2
        dest: /opt/jenkins/init.groovy.d/01-create-credentials.groovy
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Copy jenkins.env configuration file
      copy:
        src: ../../jenkins/jenkins.env
        dest: /opt/jenkins/workspace/jenkins.env
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Run Jenkins container
      command: >
        docker run -d
        --name jenkins
        --restart unless-stopped
        -p 8080:8080
        -p 50000:50000
        -e JAVA_OPTS="-Djenkins.install.runSetupWizard=false"
        -v /opt/jenkins:/var/jenkins_home
        -v /var/run/docker.sock:/var/run/docker.sock
        jenkins/jenkins:lts

    - name: Wait for Jenkins container to start
      pause:
        seconds: 10

    - name: Install sshpass in Jenkins container
      shell: |
        docker exec -u root jenkins bash -c "
          apt-get update && 
          apt-get install -y sshpass
        "

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 120

    - name: Install Jenkins plugins
      shell: |
        docker exec jenkins jenkins-plugin-cli --plugins git workflow-aggregator docker-workflow ssh-slaves credentials-binding
      ignore_errors: yes

    - name: Restart Jenkins to apply plugins
      command: docker restart jenkins

    - name: Wait for Jenkins to restart
      wait_for:
        port: 8080
        delay: 15
        timeout: 120

    - name: Wait for Jenkins to be fully ready
      pause:
        seconds: 30

    - name: Create pipeline job configuration script
      template:
        src: templates/create-pipeline.groovy.j2
        dest: /tmp/create-pipeline.groovy
        mode: '0644'

    - name: Copy script to Jenkins container
      shell: |
        docker cp /tmp/create-pipeline.groovy jenkins:/var/jenkins_home/init.groovy.d/02-create-pipeline.groovy

    - name: Create SSH credential script
      template:
        src: templates/create-ssh-credential.groovy.j2
        dest: /tmp/create-ssh-credential.groovy
        mode: '0644'

    - name: Copy SSH credential script to Jenkins
      shell: |
        docker cp /tmp/create-ssh-credential.groovy jenkins:/var/jenkins_home/init.groovy.d/03-create-ssh-credential.groovy

    - name: Restart Jenkins to execute pipeline creation
      command: docker restart jenkins

    - name: Wait for Jenkins final startup
      wait_for:
        port: 8080
        delay: 20
        timeout: 120

    - name: Generate SSH key for Jenkins
      shell: |
        docker exec -u jenkins jenkins bash -c "
          mkdir -p /var/jenkins_home/.ssh &&
          chmod 700 /var/jenkins_home/.ssh &&
          if [ ! -f /var/jenkins_home/.ssh/id_ed25519 ]; then
            ssh-keygen -t ed25519 -C 'jenkins@provedcode' -f /var/jenkins_home/.ssh/id_ed25519 -N ''
          fi
        "
      register: ssh_key_gen

    - name: Get Jenkins public SSH key
      shell: docker exec -u jenkins jenkins cat /var/jenkins_home/.ssh/id_ed25519.pub
      register: jenkins_public_key

    - name: Display Jenkins SSH public key
      debug:
        msg: 
          - "==============================================="
          - "Add this SSH key to GitHub Deploy Keys:"
          - "{{ jenkins_public_key.stdout }}"
          - "==============================================="

    - name: Configure SSH access to build and production servers
      shell: |
        for host in 192.168.1.205 192.168.1.206 192.168.1.200 192.168.1.201 192.168.1.202 192.168.1.203; do
          sshpass -p '{{ ssh_password }}' ssh -o StrictHostKeyChecking=no root@$host "
            mkdir -p /root/.ssh
            chmod 700 /root/.ssh
            echo '{{ jenkins_public_key.stdout }}' >> /root/.ssh/authorized_keys
            chmod 600 /root/.ssh/authorized_keys
          "
        done
      ignore_errors: yes

    - name: Configure Git to accept GitHub host key
      shell: |
        docker exec -u jenkins jenkins bash -c "
          ssh-keyscan github.com >> /var/jenkins_home/.ssh/known_hosts 2>/dev/null
        "