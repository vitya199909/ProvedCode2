- name: Install Jenkins via Docker on Alpine
  hosts: jenkins
  become: true

  tasks:
    - name: Fix APK repositories
      shell: |
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.22/main" > /etc/apk/repositories
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" >> /etc/apk/repositories

    - name: Update APK cache
      command: apk update

    - name: Install Docker
      apk:
        name: docker
        state: present

    - name: Enable and start Docker
      service:
        name: docker
        state: started
        enabled: yes

    - name: Stop existing Jenkins container
      command: docker stop jenkins
      ignore_errors: yes

    - name: Remove existing Jenkins container
      command: docker rm jenkins
      ignore_errors: yes

    - name: Remove old Jenkins data for clean start
      file:
        path: /opt/jenkins
        state: absent

    - name: Create Jenkins directories
      file:
        path: "/opt/jenkins/{{ item }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0755'
      loop:
        - ""
        - init.groovy.d
        - workspace

    - name: Copy plugins list
      template:
        src: templates/plugins.txt
        dest: /opt/jenkins/plugins.txt
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Jenkins init script
      template:
        src: templates/basic-security.groovy.j2
        dest: /opt/jenkins/init.groovy.d/basic-security.groovy
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Create credentials init script
      template:
        src: templates/create-credentials.groovy.j2
        dest: /opt/jenkins/init.groovy.d/01-create-credentials.groovy
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Copy jenkins.env configuration file
      copy:
        src: ../../jenkins/jenkins.env
        dest: /opt/jenkins/workspace/jenkins.env
        owner: 1000
        group: 1000
        mode: '0644'

    - name: Run Jenkins container
      command: >
        docker run -d
        --name jenkins
        --restart unless-stopped
        -p 8080:8080
        -p 50000:50000
        -e JAVA_OPTS="-Djenkins.install.runSetupWizard=false"
        -v /opt/jenkins:/var/jenkins_home
        -v /var/run/docker.sock:/var/run/docker.sock
        jenkins/jenkins:lts

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 120

    - name: Install Jenkins plugins
      shell: |
        docker exec jenkins jenkins-plugin-cli --plugins git workflow-aggregator docker-workflow ssh-slaves credentials-binding
      ignore_errors: yes

    - name: Restart Jenkins to apply plugins
      command: docker restart jenkins

    - name: Wait for Jenkins to restart
      wait_for:
        port: 8080
        delay: 15
        timeout: 120

    - name: Wait for Jenkins to be fully ready
      pause:
        seconds: 30

    - name: Create pipeline job configuration script
      template:
        src: templates/create-pipeline.groovy.j2
        dest: /tmp/create-pipeline.groovy
        mode: '0644'

    - name: Copy script to Jenkins container
      shell: |
        docker cp /tmp/create-pipeline.groovy jenkins:/var/jenkins_home/init.groovy.d/02-create-pipeline.groovy

    - name: Restart Jenkins to execute pipeline creation
      command: docker restart jenkins

    - name: Wait for Jenkins final startup
      wait_for:
        port: 8080
        delay: 20
        timeout: 120