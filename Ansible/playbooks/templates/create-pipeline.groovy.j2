#!groovy

import jenkins.model.*
import org.jenkinsci.plugins.workflow.job.WorkflowJob
import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
import hudson.plugins.git.GitSCM
import hudson.plugins.git.BranchSpec

println "=== Creating Pipeline Job ==="

def instance = Jenkins.getInstance()

def jobName = "{{ jenkins_pipeline_job_name | default('main-pipeline') }}"
def gitRepo = "{{ jenkins_pipeline_git_repo }}"
def gitBranch = "{{ jenkins_pipeline_git_branch | default('main') }}"
def jenkinsfilePath = "{{ jenkins_pipeline_jenkinsfile_path | default('Jenkinsfile') }}"

println "Job name: ${jobName}"
println "Git repo: ${gitRepo}"
println "Branch: ${gitBranch}"
println "Jenkinsfile path: ${jenkinsfilePath}"

def job = instance.getItem(jobName)
if (!job) {
    println "Creating new pipeline job..."
    job = instance.createProject(WorkflowJob.class, jobName)
    
    // Configure Git SCM
    def scm = new GitSCM(gitRepo)
    scm.branches = [new BranchSpec("*/${gitBranch}")]
    
    // Set Pipeline definition from SCM
    def flowDefinition = new CpsScmFlowDefinition(scm, jenkinsfilePath)
    flowDefinition.setLightweight(true)
    job.setDefinition(flowDefinition)
    
    job.save()
    println "Pipeline job '${jobName}' created successfully!"
} else {
    println "Pipeline job '${jobName}' already exists"
}

instance.save()
println "=== Pipeline Job Configuration Complete ==="
