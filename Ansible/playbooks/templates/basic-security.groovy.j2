#!groovy

import jenkins.model.*
import hudson.security.*
import jenkins.install.InstallState

println "=== Jenkins Initial Setup Starting ==="

def instance = Jenkins.getInstance()

println "Step 1: Creating admin user..."
def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount("admin", "{{ jenkins_admin_password | default('admin123') }}")
instance.setSecurityRealm(hudsonRealm)
println "Admin user created: admin"

println "Step 2: Setting authorization strategy..."
def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
strategy.setAllowAnonymousRead(false)
instance.setAuthorizationStrategy(strategy)
println "Authorization strategy set"

println "Step 3: Marking setup as complete..."
instance.setInstallState(InstallState.INITIAL_SETUP_COMPLETED)

instance.save()
println "=== Jenkins Initial Setup Completed ==="
println "Login: admin / Password: {{ jenkins_admin_password | default('admin123') }}"
