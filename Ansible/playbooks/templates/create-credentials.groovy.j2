#!groovy

import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.plugins.credentials.impl.*
import org.jenkinsci.plugins.plaincredentials.impl.*
import hudson.util.Secret

println "=== Creating Credentials ==="

def instance = Jenkins.getInstance()
def domain = Domain.global()
def store = instance.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

// SSH Password
def sshPassword = "{{ ssh_password | default('your_ssh_password') }}"
if (!store.getCredentials(domain).find { it.id == 'ssh-password' }) {
    store.addCredentials(domain, new UsernamePasswordCredentialsImpl(
        CredentialsScope.GLOBAL, "ssh-password", "SSH Password", "root", sshPassword
    ))
    println "✅ SSH password created"
}

// Database credentials
if (!store.getCredentials(domain).find { it.id == 'db-login' }) {
    store.addCredentials(domain, new StringCredentialsImpl(
        CredentialsScope.GLOBAL, "db-login", "Database Login", Secret.fromString("{{ db_login | default('myuser') }}")
    ))
    println "✅ DB login created"
}

if (!store.getCredentials(domain).find { it.id == 'db-password' }) {
    store.addCredentials(domain, new StringCredentialsImpl(
        CredentialsScope.GLOBAL, "db-password", "Database Password", Secret.fromString("{{ db_password | default('mypass') }}")
    ))
    println "✅ DB password created"
}

// S3 credentials
if (!store.getCredentials(domain).find { it.id == 's3-access-key' }) {
    store.addCredentials(domain, new StringCredentialsImpl(
        CredentialsScope.GLOBAL, "s3-access-key", "S3 Access Key", Secret.fromString("{{ s3_access_key | default('test') }}")
    ))
    println "✅ S3 access key created"
}

if (!store.getCredentials(domain).find { it.id == 's3-secret-key' }) {
    store.addCredentials(domain, new StringCredentialsImpl(
        CredentialsScope.GLOBAL, "s3-secret-key", "S3 Secret Key", Secret.fromString("{{ s3_secret_key | default('test') }}")
    ))
    println "✅ S3 secret key created"
}

// Email credentials (if provided)
{% if email_user %}
if (!store.getCredentials(domain).find { it.id == 'email-credentials' }) {
    store.addCredentials(domain, new UsernamePasswordCredentialsImpl(
        CredentialsScope.GLOBAL, "email-credentials", "Email Credentials", "{{ email_user }}", "{{ email_password | default('') }}"
    ))
    println "✅ Email credentials created"
}
{% endif %}

instance.save()
println "=== Credentials Configuration Complete ==="
