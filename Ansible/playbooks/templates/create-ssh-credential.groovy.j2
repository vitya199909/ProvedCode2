#!groovy

import jenkins.model.*
import com.cloudbees.jenkins.plugins.sshcredentials.impl.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.plugins.credentials.impl.*
import org.jenkinsci.plugins.plaincredentials.impl.*

println "=== Creating SSH Key Credential ==="

def instance = Jenkins.getInstance()
def domain = Domain.global()
def store = instance.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

// Read SSH private key from file
def privateKeyFile = new File('/var/jenkins_home/.ssh/id_ed25519')
if (privateKeyFile.exists()) {
    def privateKey = privateKeyFile.text
    
    if (!store.getCredentials(domain).find { it.id == 'jenkins-ssh-key' }) {
        def sshCredential = new BasicSSHUserPrivateKey(
            CredentialsScope.GLOBAL,
            "jenkins-ssh-key",
            "jenkins",
            new BasicSSHUserPrivateKey.DirectEntryPrivateKeySource(privateKey),
            "",
            "Jenkins SSH Key for Git"
        )
        
        store.addCredentials(domain, sshCredential)
        println "✅ SSH key credential created successfully!"
    } else {
        println "⚠️ SSH key credential already exists"
    }
} else {
    println "❌ SSH private key file not found: /var/jenkins_home/.ssh/id_ed25519"
}

instance.save()
println "=== SSH Key Credential Configuration Complete ==="
