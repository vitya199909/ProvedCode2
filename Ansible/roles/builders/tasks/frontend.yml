---
- name: Ensure necessary packages are installed
  apk:
    name:
      - bash
      - curl
      - unzip
      - git
      - zip
      - docker
    state: present

- name: Enable and start Docker
  service:
    name: docker
    state: started
    enabled: yes

- name: Pull Node.js 18 Docker image
  command: docker pull node:18-alpine

- name: Create node wrapper script
  copy:
    dest: /usr/local/bin/node
    mode: '0755'
    content: |
      #!/bin/sh
      docker run --rm -i \
        -v "$(pwd)":/workspace \
        -w /workspace \
        node:18-alpine \
        node "$@"

- name: Create npm wrapper script
  copy:
    dest: /usr/local/bin/npm
    mode: '0755'
    content: |
      #!/bin/sh
      docker run --rm -i \
        -v "$(pwd)":/workspace \
        -v "$HOME/.npm":/root/.npm \
        -w /workspace \
        node:18-alpine \
        npm "$@"

- name: Create npx wrapper script
  copy:
    dest: /usr/local/bin/npx
    mode: '0755'
    content: |
      #!/bin/sh
      docker run --rm -i \
        -v "$(pwd)":/workspace \
        -v "$HOME/.npm":/root/.npm \
        -w /workspace \
        node:18-alpine \
        npx "$@"

- name: Check Node version
  command: docker run --rm node:18-alpine node -v
  register: node_version_out

- name: Check NPM version
  command: docker run --rm node:18-alpine npm -v
  register: npm_version_out

- name: Show installed versions
  debug:
    msg:
      - "Node version (Docker): {{ node_version_out.stdout }}"
      - "NPM version (Docker): {{ npm_version_out.stdout }}"